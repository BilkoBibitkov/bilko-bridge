steps:
# Step 1: Git & Branch Prep
- name: 'gcr.io/cloud-builders/git'
  secretEnv: ['GH_TOKEN']
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    git config --global user.email "ralph-agent@bilkobibitkov.com"
    git config --global user.name "Ralph Agent"
    # Note the double $$ - this is the key to fixing your error
    git remote set-url origin https://\$\$GH_TOKEN@github.com/BilkoBibitkov/bilko-bridge.git
    git checkout -B main
    cp PRD.json prd.json || echo "Standardized PRD"

# Step 2: Evolution (Ralph)
- name: 'python:3.11'
  secretEnv: ['GEMINI_API_KEY']
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    pip install google-genai
    echo "GEMINI_API_KEY=\$\$GEMINI_API_KEY" > .env
    chmod +x ralph.sh
    ./ralph.sh 5

# Step 3: Push back to GitHub
- name: 'gcr.io/cloud-builders/git'
  secretEnv: ['GH_TOKEN']
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    git add .
    git commit -m "chore: Ralph evolution update [skip ci]" || echo "No changes"
    git push origin main

availableSecrets:
  secretManager:
  - versionName: projects/bilkobibitkov/secrets/GITHUB_PAT/versions/latest
    env: 'GH_TOKEN'
  - versionName: projects/bilkobibitkov/secrets/GEMINI_API_KEY/versions/latest
    env: 'GEMINI_API_KEY'

options:
  logging: CLOUD_LOGGING_ONLY
  # This tells Cloud Build NOT to get confused by variables it doesn't recognize
  substitutionOption: ALLOW_LOOSE