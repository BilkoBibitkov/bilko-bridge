steps:
  # --- Step 0: Git Configuration ---
  - name: 'gcr.io/cloud-builders/git'
    id: 'Git Configuration'
    secretEnv: ['GH_TOKEN']
    script: |
      #!/usr/bin/env bash
      git config --global --add safe.directory /workspace
      git config --global user.email "ralph@bilkobibitkov.com"
      git config --global user.name "Ralph (AI Architect)"
      git remote set-url origin https://$GH_TOKEN@github.com/BilkoBibitkov/bilko-bridge.git
      git checkout -B main

  # --- Step 1: Model Selection ---
  - name: 'gcr.io/bilkobibitkov/ralph-brain:latest'
    id: 'Probing Models'
    secretEnv: ['GOOGLE_API_KEY']
    script: |
      #!/usr/bin/env bash
      # Probe for health. If 503 is detected, this script will log it.
      python bridge.py --probe || echo "Warning: Primary model capacity low."

  # --- Step 2: The Resilient Brain (Ralph) ---
  - name: 'gcr.io/bilkobibitkov/ralph-brain:latest'
    id: 'Ralph Evolution'
    secretEnv: ['GOOGLE_API_KEY', 'FIREBASE_API_KEY', 'FIREBASE_PROJECT_ID', 'FIREBASE_AUTH_DOMAIN', 'FIREBASE_ADMIN_KEY']
    script: |
      #!/usr/bin/env bash
      set -e
      export NEXT_PUBLIC_FIREBASE_API_KEY=$FIREBASE_API_KEY
      export NEXT_PUBLIC_FIREBASE_PROJECT_ID=$FIREBASE_PROJECT_ID
      export NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=$FIREBASE_AUTH_DOMAIN
      echo "$FIREBASE_ADMIN_KEY" > service-account.json

      # RESILIENCE LOOP: Try up to 3 times with increasing wait times
      MAX_RETRIES=3
      RETRY_COUNT=0
      
      until python bridge.py || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
        RETRY_COUNT=$((RETRY_COUNT + 1))
        WAIT_TIME=$((RETRY_COUNT * 60)) # Wait 60s, then 120s
        echo "503/Overload detected. Retrying in $WAIT_TIME seconds (Attempt $RETRY_COUNT/$MAX_RETRIES)..."
        sleep $WAIT_TIME
      done

      # FALLBACK: If flash is still dead, try the Pro model
      if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
        echo "Primary model failed. Attempting fallback to gemini-1.5-pro..."
        export PREFERRED_MODEL="gemini-1.5-pro"
        python bridge.py
      fi

  # --- Step 3: Application Build (Node) ---
  - name: 'node:20'
    id: 'App Build'
    script: |
      #!/usr/bin/env bash
      npm install
      npm run build

  # --- Step 4: Firebase Deployment ---
  - name: 'gcr.io/bilkobibitkov/firebase'
    id: 'Firebase Deploy'
    args: ['deploy', '--only', 'hosting', '--project', 'bilkobibitkov']

  # --- Step 5: State Synchronization ---
  - name: 'gcr.io/cloud-builders/git'
    id: 'Push Evolution'
    secretEnv: ['GH_TOKEN']
    script: |
      #!/usr/bin/env bash
      git add .
      git commit -m "chore: Ralph evolution update [skip ci]" || echo "No changes"
      git push origin main

availableSecrets:
  secretManager:
  - versionName: projects/$PROJECT_ID/secrets/GITHUB_PAT/versions/latest
    env: 'GH_TOKEN'
  - versionName: projects/$PROJECT_ID/secrets/GEMINI_API_KEY/versions/latest
    env: 'GOOGLE_API_KEY'
  - versionName: projects/$PROJECT_ID/secrets/FIREBASE_API_KEY/versions/latest
    env: 'FIREBASE_API_KEY'
  - versionName: projects/$PROJECT_ID/secrets/FIREBASE_PROJECT_ID/versions/latest
    env: 'FIREBASE_PROJECT_ID'
  - versionName: projects/$PROJECT_ID/secrets/FIREBASE_AUTH_DOMAIN/versions/latest
    env: 'FIREBASE_AUTH_DOMAIN'
  - versionName: projects/$PROJECT_ID/secrets/FIREBASE_ADMIN_KEY/versions/latest
    env: 'FIREBASE_ADMIN_KEY'

options:
  substitution_option: ALLOW_LOOSE
  logging: CLOUD_LOGGING_ONLY
timeout: '1500s'